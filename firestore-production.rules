rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Production-ready shopping lists with secure QR sharing
    match /shoppingLists/{listId} {
      // Users can read lists they created or are shared with
      // Support both deviceUID (legacy) and creatorId (new)
      allow read: if request.auth != null
        && (resource.data.deviceUID == request.auth.uid
            || resource.data.creatorId == request.auth.uid
            || request.auth.uid in resource.data.get('sharedWith', []));
      
      // Only authenticated users can create lists
      allow create: if request.auth != null
        && (request.resource.data.deviceUID == request.auth.uid
            || request.resource.data.creatorId == request.auth.uid)
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 100
        && request.resource.data.items is list
        && request.resource.data.get('sharedWith', []) is list;
      
      // Secure update rules with QR sharing support
      allow update: if request.auth != null
        && (
          // Creator can always update (legacy deviceUID or new creatorId)
          resource.data.deviceUID == request.auth.uid
          || resource.data.creatorId == request.auth.uid
          // Users already shared with can update
          || request.auth.uid in resource.data.get('sharedWith', [])
          // QR sharing: allow users to add themselves to sharedWith array
          || (
            // User is adding themselves to sharedWith
            request.auth.uid in request.resource.data.get('sharedWith', [])
            && !(request.auth.uid in resource.data.get('sharedWith', []))
            // Prevent changing critical fields during QR sharing
            && request.resource.data.deviceUID == resource.data.deviceUID
            && request.resource.data.creatorId == resource.data.creatorId
            && request.resource.data.name == resource.data.name
            && request.resource.data.items == resource.data.items
            // Only allow adding to sharedWith, not removing others
            && resource.data.get('sharedWith', []).toSet().isSubsetOf(
                 request.resource.data.get('sharedWith', []).toSet()
               )
          )
        )
        // Always prevent changing creator fields
        && request.resource.data.deviceUID == resource.data.deviceUID
        && request.resource.data.creatorId == resource.data.creatorId;
      
      // Only the creator can delete lists
      allow delete: if request.auth != null
        && (resource.data.deviceUID == request.auth.uid
            || resource.data.creatorId == request.auth.uid);
    }
  }
}