rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Shopping lists with creator permissions and sharing support
    match /shoppingLists/{listId} {
      // Users can read lists they created or are shared with
      allow read: if request.auth != null
        && (resource.data.creatorId == request.auth.uid
            || request.auth.uid in resource.data.sharedWith);
      
      // Only authenticated users can create lists
      allow create: if request.auth != null
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.name.size() <= 100
        && request.resource.data.items is list
        && request.resource.data.sharedWith is list;
      
      // Users can update lists they created, are shared with, OR are adding themselves via QR sharing
      allow update: if request.auth != null
        && (
          // Creator can always update
          resource.data.creatorId == request.auth.uid
          // Users already shared with can update
          || request.auth.uid in resource.data.sharedWith
          // QR sharing: allow users to add themselves to sharedWith array
          || (
            request.auth.uid in request.resource.data.sharedWith
            && !(request.auth.uid in resource.data.sharedWith)
            && request.resource.data.creatorId == resource.data.creatorId
            && request.resource.data.name == resource.data.name
            && request.resource.data.items == resource.data.items
          )
        )
        && request.resource.data.creatorId == resource.data.creatorId; // Prevent changing creator
      
      // Only the creator can delete lists
      allow delete: if request.auth != null
        && resource.data.creatorId == request.auth.uid;
    }
  }
}